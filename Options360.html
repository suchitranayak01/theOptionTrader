<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>TheOptionTrader - Dashboard</title>
    <link rel="stylesheet" href="style.css?v=20260111" />
    <!-- Poppins + Inter + Orbitron fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="alerts.js"></script>
  </head>
  <body>
    <header class="app-header">
      <div class="app-title">
        <a href="index.html" style="text-decoration: none;">
          <div class="brand" style="cursor: pointer;">
            <img src="logo.svg" alt="TheOptionTrader" style="width: 68px; height: 68px;" class="logo-image"/>
            <h1 class="logo" aria-label="TheOptionTrader">
              <span>T</span><span>h</span><span>e</span><span>O</span><span>p</span><span>t</span><span>i</span><span>o</span><span>n</span><span>T</span><span>r</span><span>a</span><span>d</span><span>e</span><span>r</span>
            </h1>
          </div>
        </a>
        <p class="subtitle">ATM Call + ATM Put (TradingView + Live Data)</p>
      </div>
      <div class="header-actions">
        <a class="btn ghost" href="index.html">Home</a>
        <div class="live-badge" id="liveBadge" title="Live status">
          <span class="dot" id="liveDot"></span>
          <span class="live-text" id="liveText">Offline</span>
        </div>
        <a class="btn ghost" href="login.html">Login</a>
      </div>
    </header>

    <!-- Live Ticker Section -->
    <section class="live-ticker">
      <div class="ticker-container">
        <div class="ticker-status" id="ticker-status">Demo Mode</div>
        <div class="ticker-item" id="nifty-ticker">
          <div class="ticker-name">NIFTY</div>
          <div class="ticker-value" id="nifty-value">--</div>
          <div class="ticker-change" id="nifty-change">--</div>
        </div>
        <div class="ticker-item" id="sensex-ticker">
          <div class="ticker-name">SENSEX</div>
          <div class="ticker-value" id="sensex-value">--</div>
          <div class="ticker-change" id="sensex-change">--</div>
        </div>
        <div class="ticker-item" id="banknifty-ticker">
          <div class="ticker-name">BANK NIFTY</div>
          <div class="ticker-value" id="banknifty-value">--</div>
          <div class="ticker-change" id="banknifty-change">--</div>
        </div>
      </div>
    </section>

    <!-- Market Indicators Section -->
    <section class="market-indicators">
      <div class="indicators-container">
        <div class="indicator-card vix-card">
          <div class="indicator-header">
            <span class="indicator-icon">âš¡</span>
            <span class="indicator-label">India VIX</span>
          </div>
          <div class="indicator-value" id="vix-value">--</div>
          <div class="indicator-change" id="vix-change">--</div>
          <div class="indicator-status" id="vix-status">Calculating...</div>
        </div>

        <div class="indicator-card pcr-card">
          <div class="indicator-header">
            <span class="indicator-icon">ðŸ“Š</span>
            <span class="indicator-label">Put-Call Ratio</span>
          </div>
          <div class="indicator-value" id="pcr-value">--</div>
          <div class="indicator-change" id="pcr-change">--</div>
          <div class="indicator-status" id="pcr-status">Neutral</div>
        </div>

        <div class="indicator-card iv-card">
          <div class="indicator-header">
            <span class="indicator-icon">ðŸ“ˆ</span>
            <span class="indicator-label">Implied Volatility</span>
          </div>
          <div class="indicator-value" id="iv-value">--</div>
          <div class="indicator-change" id="iv-change">--</div>
          <div class="indicator-status" id="iv-status">Moderate</div>
        </div>

        <div class="indicator-card oi-card">
          <div class="indicator-header">
            <span class="indicator-icon">ðŸ’¼</span>
            <span class="indicator-label">Open Interest</span>
          </div>
          <div class="indicator-value" id="oi-value">--</div>
          <div class="indicator-change" id="oi-change">--</div>
          <div class="indicator-status" id="oi-status">Loading...</div>
        </div>
      </div>
    </section>

    <main class="app-grid">
      <aside class="sidebar card">
        <h4>Controls</h4>
        <div class="controls">
          <label>
            <span>Market:</span>
            <select id="marketType">
              <option value="equity">Equity</option>
              <option value="mcx">MCX</option>
            </select>
          </label>

          <label>
            <span>Index:</span>
            <select id="indexSelect">
              <option value="nifty">Nifty</option>
              <option value="sensex">Sensex</option>
            </select>
          </label>

          <label>
            <span>Expiry Date:</span>
            <select id="expiryDate">
              <option value="2025-01-02">2025-01-02</option>
              <option value="2025-01-16">2025-01-16</option>
              <option value="2026-01-08">2026-01-08</option>
              <option value="2026-01-15">2026-01-15</option>
            </select>
          </label>

          <label>
            <input type="checkbox" id="useLive" /> Enable Live Data
          </label>

          <label>
            <span>Refresh Interval (sec):</span>
            <input id="liveInterval" type="number" min="5" max="600" value="60" />
          </label>

          <div class="form-actions">
            <button id="refreshBtn">Refresh Data</button>
          </div>
        </div>

        <!-- Alert Settings Card -->
        <div class="card" style="margin-top: 20px; background: rgba(234, 179, 8, 0.05); border-color: rgba(234, 179, 8, 0.3);">
          <h4 style="color: #eab308; margin-bottom: 1rem;">ðŸ”” Alert Settings</h4>
          
          <label>
            <input type="checkbox" id="enableAlerts" checked /> Enable Alerts
          </label>

          <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 1rem 0 0.5rem 0;">IV Alerts (when IV > threshold)</h5>
          <label>
            <input type="checkbox" id="ivAlertEnabled" checked /> IV Alert
          </label>
          <label>
            <span>IV Threshold (%):</span>
            <input id="ivThreshold" type="number" value="20" min="0" max="100" />
          </label>

          <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 1rem 0 0.5rem 0;">PCR Shift Alerts</h5>
          <label>
            <input type="checkbox" id="pcrAlertEnabled" checked /> PCR Alert
          </label>
          <label>
            <span>Bullish PCR (>):</span>
            <input id="pcrBullish" type="number" value="1.0" step="0.1" />
          </label>
          <label>
            <span>Bearish PCR (<):</span>
            <input id="pcrBearish" type="number" value="1.0" step="0.1" />
          </label>

          <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 1rem 0 0.5rem 0;">Straddle Premium Jump Alerts</h5>
          <label>
            <input type="checkbox" id="straddleAlertEnabled" checked /> Straddle Alert
          </label>
          <label>
            <input type="checkbox" id="alert10Enabled" checked /> 10% Jump Alert
          </label>
          <label>
            <input type="checkbox" id="alert20Enabled" checked /> 20% Jump Alert
          </label>
          <label>
            <input type="checkbox" id="alert30Enabled" checked /> 30% Jump Alert
          </label>

          <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 1rem 0 0.5rem 0;">Notification Channels</h5>
          <label>
            <input type="checkbox" id="soundAlerts" checked /> Sound
          </label>
          <label>
            <input type="checkbox" id="whatsappAlerts" /> WhatsApp
          </label>
          <label>
            <input type="checkbox" id="telegramAlerts" /> Telegram
          </label>
          <label>
            <input type="checkbox" id="instaAlerts" /> Instagram
          </label>

          <div style="margin-top: 1rem; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 0.85rem; color: #94a3b8;">
            ðŸ’¡ WhatsApp, Telegram & Instagram alerts require setup in settings
          </div>
        </div>

        <!-- Live Chat Card -->
        <div class="card" style="margin-top: 20px; background: rgba(34, 197, 94, 0.05); border-color: rgba(34, 197, 94, 0.3);">
          <h4 style="color: #22c55e; margin-bottom: 1rem;">ðŸ’¬ Live Discussion</h4>
          <div id="chatBox" style="background: #0f172a; border-radius: 8px; padding: 10px; height: 200px; overflow-y: auto; margin-bottom: 10px;">
            <div style="color: #64748b; text-align: center; padding: 20px;">
              Chat will be available in live mode
            </div>
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="chatInput" placeholder="Type your message..." style="flex: 1; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e6eef8;" />
            <button onclick="sendChatMessage()" style="background: #22c55e; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Send</button>
          </div>
        </div>
      </aside>

      <section class="content">
        <div class="card metrics-row">
          <div class="metric">
            <div class="metric-value" id="metric-iv">IV: --</div>
            <div class="metric-label">Straddle IV</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="metric-pcr">PCR: --</div>
            <div class="metric-label">PCR</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="metric-price">Price: --</div>
            <div class="metric-label">Last Price</div>
          </div>
        </div>
        <div class="card metrics-row">
          <div class="metric">
            <div class="metric-value" id="metric-call">Call: --</div>
            <div class="metric-label">Live Call Premium</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="metric-put">Put: --</div>
            <div class="metric-label">Live Put Premium</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="metric-straddle">Straddle: --</div>
            <div class="metric-label">Straddle Price</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="metric-updated">Updated: --</div>
            <div class="metric-label">Last Updated</div>
          </div>
        </div>

        <div class="card chart-card">
          <div id="status" class="status"></div>
          <div class="chart-tabs">
            <button id="chartTabBtn" class="tab-btn active">Price Chart</button>
            <button id="tvTabBtn" class="tab-btn">TradingView</button>
          </div>
          <div id="priceChartContainer">
            <canvas id="straddleChart" aria-label="Straddle chart" role="img"></canvas>
          </div>
          <div id="tradingviewContainer" style="display: none;">
            <div id="tradingview-widget" style="height: 400px;"></div>
          </div>
        </div>

        <!doctype html>
        <html lang="en">
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
          <meta http-equiv="Pragma" content="no-cache" />
          <meta http-equiv="Expires" content="0" />
          <title>TheOptionTrader - Options 360</title>
          <link rel="stylesheet" href="style.css?v=20260111" />
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <style>
            :root {
              --bg: #050b13;
              --panel: #0b1220;
              --card: #0f172a;
              --border: #1e293b;
              --text: #e6eef8;
              --muted: #94a3b8;
              --accent: #3b82f6;
              --good: #22c55e;
              --bad: #ef4444;
            }
            * { box-sizing: border-box; }
            body { margin:0; padding:20px; background:var(--bg); color:var(--text); font-family:'Helvetica Neue', Helvetica, Arial, sans-serif; }
            a { color:inherit; text-decoration:none; }
            header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
            .brand { display:flex; align-items:center; gap:12px; font-weight:800; font-size:22px; letter-spacing:0.5px; }
            .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(59,130,246,0.12); font-size:12px; }
            .grid { display:grid; gap:12px; }
            .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
            .row { display:flex; gap:12px; align-items:center; }
            .tickers { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
            .ticker { padding:14px; background:var(--panel); border:1px solid var(--border); border-radius:12px; }
            .t-name { color:var(--muted); font-size:16px; font-weight:600; }
            .t-value { font-size:32px; font-weight:700; }
            .t-change { font-size:16px; font-weight:600; }
            .pos { color:var(--good); } .neg { color:var(--bad); }
            .controls { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            label { display:flex; flex-direction:column; gap:6px; font-size:13px; color:var(--muted); }
            select { padding:10px; border-radius:8px; border:1px solid var(--border); background:#0b1220; color:var(--text); }
            .indicators { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
            .indicator h4 { margin:0 0 6px 0; font-size:14px; color:var(--muted); letter-spacing:0.4px; }
            .indicator .val { font-size:28px; font-weight:700; }
            .indicator .sub { font-size:13px; font-weight:600; }
            .status { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; border:1px solid var(--border); font-size:12px; color:var(--muted); margin-top:6px; }
            .chart-wrap { margin-top:10px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; min-height:50vh; }
            .chart-wrap canvas { height:45vh !important; }
            .chart-toggle { display:flex; gap:16px; align-items:center; margin-bottom:10px; }
            .subtitle { color:var(--muted); font-size:13px; margin:4px 0 0; }
            .footer { color:var(--muted); font-size:12px; margin-top:16px; }
            .badge-green { color:var(--good); } .badge-red { color:var(--bad); }
            #chatWidget { position:fixed; bottom:20px; right:20px; width:360px; max-height:500px; background:var(--card); border:2px solid var(--border); border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.4); z-index:999; display:flex; flex-direction:column; transition:all 0.3s ease; }
            #chatWidget.minimized { max-height:50px; }
            .chat-header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--panel); border-radius:14px 14px 0 0; cursor:pointer; }
            .chat-header h3 { margin:0; font-size:15px; font-weight:700; }
            .chat-controls { display:flex; gap:8px; }
            .chat-controls button { background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:16px; padding:4px 8px; border-radius:6px; }
            .chat-controls button:hover { background:var(--border); }
            .chat-body { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px; max-height:350px; }
            #chatWidget.minimized .chat-body { display:none; }
            .chat-message { padding:8px 12px; border-radius:8px; background:var(--panel); font-size:13px; }
            .chat-message.own { background:rgba(59,130,246,0.2); margin-left:40px; }
            .chat-message .user { font-weight:700; font-size:12px; color:var(--accent); margin-bottom:4px; }
            .chat-message .time { font-size:11px; color:var(--muted); margin-left:8px; }
            .chat-input-wrap { padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; }
            #chatWidget.minimized .chat-input-wrap { display:none; }
            .chat-input-wrap input { flex:1; padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:13px; }
            .chat-input-wrap button { padding:8px 16px; border-radius:8px; border:none; background:var(--accent); color:white; font-weight:600; cursor:pointer; }
            .chat-input-wrap button:hover { background:#2563eb; }
            @media(max-width:768px){ body{padding:12px;} header{flex-direction:column; align-items:flex-start;} #chatWidget{width:calc(100% - 40px); right:20px;} }
          </style>
        </head>
        <body>
          <header>
            <div>
              <div class="brand">TheOptionTrader Â· Options 360</div>
              <div class="subtitle">Live overview for Nifty, Sensex, Bank Nifty</div>
            </div>
            <div class="row">
              <span class="pill" id="livePill"><span class="dot" style="width:8px;height:8px;border-radius:50%;background:var(--good);"></span>Live</span>
              <a class="pill" href="login.html" id="loginLink">Login</a>
            </div>
          </header>

          <!-- Tickers -->
          <section class="grid tickers">
            <div class="ticker">
              <div class="t-name">NIFTY 50</div>
              <div class="t-value" id="niftyVal">--</div>
              <div class="t-change" id="niftyChg">--</div>
            </div>
            <div class="ticker">
              <div class="t-name">SENSEX</div>
              <div class="t-value" id="sensexVal">--</div>
              <div class="t-change" id="sensexChg">--</div>
            </div>
            <div class="ticker">
              <div class="t-name">BANK NIFTY</div>
              <div class="t-value" id="bankVal">--</div>
              <div class="t-change" id="bankChg">--</div>
            </div>
          </section>

          <!-- Controls -->
          <section class="card">
            <div class="grid controls">
              <label>Market
                <select id="marketSelect">
                  <option value="equity">Equity</option>
                  <option value="commodity">Commodity</option>
                  <option value="currency">Currency</option>
                </select>
              </label>
              <label>Symbol
                <select id="symbolSelect"></select>
              </label>
              <label>Expiry Date
                <select id="expirySelect"></select>
              </label>
              <label>Strike Price
                <select id="strikeSelect"></select>
              </label>
            </div>
          </section>

          <!-- Indicators -->
          <section class="grid indicators">
            <div class="card indicator">
              <h4>Implied Volatility (IV)</h4>
              <div class="val" id="ivVal">--</div>
              <div class="sub" id="ivChg">--</div>
              <div class="status" id="ivStatus">Monitoringâ€¦</div>
            </div>
            <div class="card indicator">
              <h4>Put/Call Ratio (PCR)</h4>
              <div class="val" id="pcrVal">--</div>
              <div class="sub" id="pcrChg">--</div>
              <div class="status" id="pcrStatus">Neutral</div>
            </div>
            <div class="card indicator">
              <h4>VIX</h4>
              <div class="val" id="vixVal">--</div>
              <div class="sub" id="vixChg">--</div>
              <div class="status" id="vixStatus">Calm</div>
            </div>
            <div class="card indicator">
              <h4>Straddle Premium</h4>
              <div class="val" id="straddleVal">--</div>
              <div class="sub" id="straddleSub">--</div>
              <div class="status" id="straddleStatus">Monitoringâ€¦</div>
            </div>
            <div class="card indicator">
              <h4>ATM Call Premium</h4>
              <div class="val" id="callVal">--</div>
              <div class="sub" id="callSub">--</div>
              <div class="status">ATM Call</div>
            </div>
            <div class="card indicator">
              <h4>ATM Put Premium</h4>
              <div class="val" id="putVal">--</div>
              <div class="sub" id="putSub">--</div>
              <div class="status">ATM Put</div>
            </div>
            <div class="card indicator">
              <h4>Last Updated</h4>
              <div class="val" id="lastUpdated">--:--:--</div>
              <div class="sub">Auto-refreshing every 5s</div>
              <div class="status">System Clock</div>
            </div>
          </section>

          <!-- Straddle Chart -->
          <section class="card chart-wrap">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:700;">Straddle Premium Chart</div>
                <div class="subtitle">Live line or candle view</div>
              </div>
              <div class="chart-toggle">
                <label><input type="radio" name="chartMode" value="live" checked /> Live</label>
                <label><input type="radio" name="chartMode" value="candle" /> Candle</label>
              </div>
            </div>
            <canvas id="straddleChart"></canvas>
          </section>

          <div class="footer">Demo only. Not trading advice.</div>

          <!-- Floating Chat Widget -->
          <div id="chatWidget">
            <div class="chat-header" onclick="toggleChat()">
              <h3>ðŸ’¬ Live Discussion</h3>
              <div class="chat-controls">
                <button id="minimizeBtn" onclick="event.stopPropagation(); toggleChat();">âˆ’</button>
              </div>
            </div>
            <div class="chat-body" id="chatBody">
              <div class="chat-message">
                <div class="user">Trader1<span class="time">12:45 PM</span></div>
                <div>Nifty showing strong support at 21800</div>
              </div>
              <div class="chat-message own">
                <div class="user">You<span class="time">12:46 PM</span></div>
                <div>Agreed! IV is also dropping</div>
              </div>
              <div class="chat-message">
                <div class="user">Trader2<span class="time">12:47 PM</span></div>
                <div>Good time for straddle entry?</div>
              </div>
            </div>
            <div class="chat-input-wrap">
              <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter')sendMessage()" />
              <button onclick="sendMessage()">Send</button>
            </div>
          </div>

          <script>
            // Symbol lists
            const symbols = {
              equity: ['Nifty', 'Sensex', 'Bank Nifty'],
              commodity: ['Gold', 'Goldm', 'Silver', 'Silverm'],
              currency: ['USDINR']
            };

            // State
            const state = {
              dayLowStraddle: null,
              chart: null,
              chartMode: 'live',
              alertsEnabled: true,
              selectedStrike: null,
              ohlcData: []
            };

            const marketSelect = document.getElementById('marketSelect');
            const symbolSelect = document.getElementById('symbolSelect');
            const expirySelect = document.getElementById('expirySelect');
            const strikeSelect = document.getElementById('strikeSelect');

            // Populate dropdowns
            function populateSymbols() {
              const market = marketSelect.value;
              symbolSelect.innerHTML = symbols[market].map(s => `<option value="${s}">${s}</option>`).join('');
            }

            function populateExpiry() {
              const today = new Date();
              const options = [];
              for (let i = 1; i <= 4; i++) {
                const d = new Date(today.getTime() + i * 7 * 24 * 3600 * 1000);
                options.push(d.toISOString().split('T')[0]);
              }
              expirySelect.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join('');
            }

            function populateStrikes() {
              const basePrice = parseFloat(document.getElementById('niftyVal').textContent) || 21800;
              const nearestStrike = Math.round(basePrice / 50) * 50;
              const strikes = [];
              for (let i = -5; i <= 5; i++) {
                strikes.push(nearestStrike + i * 50);
              }
              strikeSelect.innerHTML = strikes.map(s => `<option value="${s}" ${s === nearestStrike ? 'selected' : ''}>${s} ${s === nearestStrike ? '(ATM)' : ''}</option>`).join('');
              state.selectedStrike = nearestStrike;
            }

            marketSelect.addEventListener('change', populateSymbols);
            symbolSelect.addEventListener('change', populateStrikes);
            populateSymbols();
            populateExpiry();
            setTimeout(populateStrikes, 1000);

            // Play alert tone
            function playBeep(f=880, dur=180) {
              const ctx = new (window.AudioContext || window.webkitAudioContext)();
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.frequency.value = f;
              osc.type = 'sine';
              gain.gain.setValueAtTime(0.15, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur/1000);
              osc.connect(gain).connect(ctx.destination);
              osc.start();
              osc.stop(ctx.currentTime + dur/1000);
            }

            // Chart setup
            const ctxChart = document.getElementById('straddleChart').getContext('2d');
            state.chart = new Chart(ctxChart, {
              type: 'line',
              data: { labels: [], datasets: [{ label:'Straddle Premium', data: [], borderColor: '#3b82f6', backgroundColor:'rgba(59,130,246,0.2)', tension:0.2 }] },
              options: { responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{ticks:{color:'#cbd5e1'}, grid:{color:'rgba(148,163,184,0.2)'}}, x:{grid:{color:'rgba(148,163,184,0.2)'}}} }
            });

            document.querySelectorAll('input[name="chartMode"]').forEach(r => {
              r.addEventListener('change', e => {
                state.chartMode = e.target.value;
                updateChartType();
              });
            });

            function updateChartType() {
              state.chart.destroy();
              const ds = state.chart.data.datasets[0];
              if (state.chartMode === 'candle') {
                state.chart = new Chart(ctxChart, {
                  type: 'candlestick',
                  data: { datasets: [{ label: 'Straddle', data: state.ohlcData, borderColor: '#eab308', backgroundColor: 'rgba(234,179,8,0.25)' }] },
                  options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { x: { type: 'time', time: { unit: 'minute' }, display: true, ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.2)' } }, y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.2)' } } } }
                });
              } else {
                state.chart = new Chart(ctxChart, {
                  type: 'line',
                  data: { labels: state.chart.data.labels, datasets: [{ label: 'Straddle Premium', data: ds.data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.2)', tension: 0.2 }] },
                  options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { x: { display: false, grid: { color: 'rgba(148,163,184,0.2)' } }, y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.2)' } } } }
                });
              }
            }

            // Data simulation
            function randBetween(min, max) { return min + Math.random() * (max - min); }

            function generateSnapshot() {
              return {
                nifty: { price: randBetween(21500, 22000), chg: randBetween(-1.2, 1.2) },
                sensex: { price: randBetween(72000, 74000), chg: randBetween(-1.0, 1.0) },
                bank: { price: randBetween(45500, 46500), chg: randBetween(-1.5, 1.5) },
                iv: { val: randBetween(12, 35), chg: randBetween(-12, 14) },
                pcr: { val: randBetween(0.7, 1.3), chg: randBetween(-0.1, 0.1) },
                vix: { val: randBetween(12, 25), chg: randBetween(-12, 14) },
                atmCall: randBetween(80, 180),
                atmPut: randBetween(70, 170)
              };
            }

            // Update UI
            function setTicker(idVal, idChg, obj) {
              document.getElementById(idVal).textContent = obj.price.toFixed(2);
              const el = document.getElementById(idChg);
              el.textContent = `${obj.chg >=0 ? '+' : ''}${obj.chg.toFixed(2)}%`;
              el.className = 't-change ' + (obj.chg >=0 ? 'pos' : 'neg');
            }

            function updateIndicators() {
              const snap = generateSnapshot();

              // tickers
              setTicker('niftyVal','niftyChg', snap.nifty);
              setTicker('sensexVal','sensexChg', snap.sensex);
              setTicker('bankVal','bankChg', snap.bank);

              // IV
              document.getElementById('ivVal').textContent = snap.iv.val.toFixed(2) + '%';
              const ivChg = snap.iv.chg;
              const ivChgEl = document.getElementById('ivChg');
              ivChgEl.textContent = `${ivChg>=0?'+':''}${ivChg.toFixed(2)}%`;
              ivChgEl.className = 'sub ' + (Math.abs(ivChg) > 10 ? 'badge-red' : 'badge-green');
              document.getElementById('ivStatus').textContent = Math.abs(ivChg) > 10 ? 'High IV move' : 'Stable';
              if (Math.abs(ivChg) > 10) playBeep(1100, 180);

              // PCR
              document.getElementById('pcrVal').textContent = snap.pcr.val.toFixed(2);
              const pcrChg = snap.pcr.chg;
              const pcrEl = document.getElementById('pcrChg');
              pcrEl.textContent = `${pcrChg>=0?'+':''}${pcrChg.toFixed(2)}`;
              pcrEl.className = 'sub ' + (pcrChg>=0 ? 'badge-green' : '');
              document.getElementById('pcrStatus').textContent = snap.pcr.val > 1.1 ? 'Bullish skew' : snap.pcr.val < 0.9 ? 'Bearish skew' : 'Neutral';

              // VIX
              document.getElementById('vixVal').textContent = snap.vix.val.toFixed(2);
              const vixChg = snap.vix.chg;
              const vixEl = document.getElementById('vixChg');
              vixEl.textContent = `${vixChg>=0?'+':''}${vixChg.toFixed(2)}%`;
              vixEl.className = 'sub ' + (Math.abs(vixChg) > 10 ? 'badge-red' : 'badge-green');
              document.getElementById('vixStatus').textContent = Math.abs(vixChg) > 10 ? 'Vol spike' : 'Calm';
              if (Math.abs(vixChg) > 10) playBeep(900, 200);

              // premiums
              document.getElementById('callVal').textContent = snap.atmCall.toFixed(2);
              document.getElementById('putVal').textContent = snap.atmPut.toFixed(2);
              document.getElementById('callSub').textContent = 'ATM Call premium';
              document.getElementById('putSub').textContent = 'ATM Put premium';

              const straddle = snap.atmCall + snap.atmPut;
              if (state.dayLowStraddle === null) state.dayLowStraddle = straddle;
              if (straddle < state.dayLowStraddle) state.dayLowStraddle = straddle;
              const fromLowPct = ((straddle - state.dayLowStraddle) / state.dayLowStraddle) * 100;

              document.getElementById('straddleVal').textContent = straddle.toFixed(2);
              const straddleSub = document.getElementById('straddleSub');
              straddleSub.textContent = `From day low: ${fromLowPct>=0?'+':''}${fromLowPct.toFixed(2)}%`;
              const straddleStatus = document.getElementById('straddleStatus');
              straddleStatus.textContent = 'Day low: ' + state.dayLowStraddle.toFixed(2);

              if (fromLowPct > 20) {
                straddleSub.className = 'sub badge-red';
                state.chart.data.datasets[0].borderColor = '#ef4444';
                state.chart.data.datasets[0].backgroundColor = 'rgba(239,68,68,0.2)';
                playBeep(700, 220);
              } else if (fromLowPct > 10) {
                straddleSub.className = 'sub badge-red';
                state.chart.data.datasets[0].borderColor = '#f59e0b';
                state.chart.data.datasets[0].backgroundColor = 'rgba(245,158,11,0.2)';
                playBeep(800, 180);
              } else {
                straddleSub.className = 'sub badge-green';
                state.chart.data.datasets[0].borderColor = '#3b82f6';
                state.chart.data.datasets[0].backgroundColor = state.chartMode === 'candle' ? 'rgba(234,179,8,0.25)' : 'rgba(59,130,246,0.2)';
              }

              // update chart
              const now = new Date();
              state.chart.data.labels.push(now.toLocaleTimeString());
              state.chart.data.datasets[0].data.push(straddle.toFixed(2));
              const ohlc = { x: now, o: straddle - randBetween(1, 3), h: straddle + randBetween(0, 2), l: straddle - randBetween(0, 2), c: straddle };
              state.ohlcData.push(ohlc);
              if (state.chart.data.labels.length > 40) {
                state.chart.data.labels.shift();
                state.chart.data.datasets[0].data.shift();
                state.ohlcData.shift();
              }
              state.chart.update();

              // last updated
              document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
            }

            updateIndicators();
            setInterval(updateIndicators, 5000);

            // Chat widget functions
            function toggleChat() {
              const widget = document.getElementById('chatWidget');
              const btn = document.getElementById('minimizeBtn');
              widget.classList.toggle('minimized');
              btn.textContent = widget.classList.contains('minimized') ? '+' : 'âˆ’';
            }

            function sendMessage() {
              const input = document.getElementById('chatInput');
              const msg = input.value.trim();
              if (!msg) return;
              const chatBody = document.getElementById('chatBody');
              const now = new Date();
              const div = document.createElement('div');
              div.className = 'chat-message own';
              div.innerHTML = `<div class="user">You<span class="time">${now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })}</span></div><div>${msg}</div>`;
              chatBody.appendChild(div);
              chatBody.scrollTop = chatBody.scrollHeight;
              input.value = '';
            }

            // Auth profile swap
            window.addEventListener('DOMContentLoaded', () => {
              if (window.AUTH && AUTH.initializeProfileDropdown) {
                AUTH.initializeProfileDropdown();
              }
            });
          </script>

          <script src="auth.js?v=20260111"></script>
        </body>
        </html>
      }


